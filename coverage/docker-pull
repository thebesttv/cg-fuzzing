#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<EOF
Usage: $0

  Pulls Docker images from stdin (one per line).
  Outputs successfully pulled images to stdout with format: "[x/y] ✅ IMAGE_NAME".
  Outputs failed pulls to stderr with format: "[x/y] ❌ IMAGE_NAME".

Example:
  echo "thebesttv/cflow-bc:latest" | $0
  cat images.txt | $0
EOF
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

# Read all image names from stdin into an array so we can show progress
mapfile -t raw_images < /dev/stdin
images=()
for img in "${raw_images[@]:-}"; do
  # Trim leading/trailing whitespace
  img="$(printf '%s' "$img" )"
  # Skip empty lines
  if [[ -z "$img" ]]; then
    continue
  fi
  images+=("$img")
done

total=${#images[@]}
if [[ "$total" -eq 0 ]]; then
  # Nothing to do
  exit 0
fi

for i in "${!images[@]}"; do
  image=${images[$i]}
  count=$((i + 1))

  # Try to pull the image. Continue on failure but record it.
  if docker pull "$image"; then
    echo "[${count}/${total}] ✅ $image"
  else
    echo "[${count}/${total}] ❌ $image" >&2
    any_failed=1
  fi
done

# If any pull failed, return non-zero. Otherwise return zero.
if [[ "${any_failed:-0}" -ne 0 ]]; then
  exit 1
fi
